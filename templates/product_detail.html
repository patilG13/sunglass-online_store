{% extends "base.html" %}

{% block title %}{{ product.name }} - SunStyle{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('products') }}">Products</a></li>
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6">
            {% if product.image_url %}
                <img src="{{ url_for('static', filename='uploads/products/' + product.image_url) }}" 
                     class="img-fluid rounded shadow" alt="{{ product.name }}" style="max-height: 500px; width: 100%; object-fit: cover;">
            {% else %}
                <img src="https://via.placeholder.com/500x400/007bff/ffffff?text={{ product.name|replace(' ', '+') }}" 
                     class="img-fluid rounded shadow" alt="{{ product.name }}" style="max-height: 500px; width: 100%; object-fit: cover;">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h1>{{ product.name }}</h1>
            <p class="text-muted">{{ product.brand }} • {{ product.category.name }}</p>
            
            <div class="price-section mb-3">
                <h2 class="text-primary">₹{{ "%.2f"|format(product.price) }}</h2>
                {% if product.discount_price %}
                <span class="original-price text-muted text-decoration-line-through">${{ "%.2f"|format(product.discount_price) }}</span>
                <span class="discount badge bg-success ms-2">Save {{ ((product.discount_price - product.price) / product.discount_price * 100)|round|int }}%</span>
                {% endif %}
            </div>

            <div class="stock-info mb-3">
                <span class="badge {{ 'bg-success' if product.stock_quantity > 10 else 'bg-warning' if product.stock_quantity > 0 else 'bg-danger' }}">
                    {{ product.stock_quantity }} in stock
                </span>
            </div>

            <div class="product-details mb-4">
                <h5>Product Details</h5>
                <ul class="list-unstyled">
                    <li><strong>Style:</strong> {{ product.style }}</li>
                    <li><strong>Color:</strong> {{ product.color }}</li>
                    <li><strong>Frame Material:</strong> {{ product.frame_material }}</li>
                    <li><strong>Lens Type:</strong> {{ product.lens_type }}</li>
                    <li><strong>UV Protection:</strong> {{ 'Yes' if product.uv_protection else 'No' }}</li>
                    <li><strong>Polarized:</strong> {{ 'Yes' if product.polarization else 'No' }}</li>
                </ul>
            </div>

            <div class="product-actions">
                {% if product.stock_quantity > 0 %}
                <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="POST" class="mb-3">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <label for="quantity" class="col-form-label">Quantity:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock_quantity }}" class="form-control" style="width: 80px;">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </form>

                <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-3" data-bs-toggle="modal" data-bs-target="#bookingModal">
                    <i class="fas fa-calendar-plus"></i> Book for Later Pickup
                </button>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> This product is currently out of stock.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Description</h5>
                </div>
                <div class="card-body">
                    <p>{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="row mt-5">
        <div class="col-12">
            <h3>Related Products</h3>
            <div class="row g-4">
                {% for related_product in related_products %}
                <div class="col-md-3">
                    <div class="product-card card h-100">
                        {% if related_product.image_url %}
                            <img src="{{ url_for('static', filename='uploads/products/' + related_product.image_url) }}" 
                                 class="card-img-top product-image" alt="{{ related_product.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <img src="https://via.placeholder.com/300x200/007bff/ffffff?text={{ related_product.name|replace(' ', '+') }}" 
                                 class="card-img-top product-image" alt="{{ related_product.name }}" style="height: 200px; object-fit: cover;">
                        {% endif %}
                        <div class="card-body">
                            <h6 class="card-title">{{ related_product.name }}</h6>
                            <p class="card-text small">{{ related_product.brand }}</p>
                            <div class="price">₹{{ "%.2f"|format(related_product.price) }}</div>
                            <a href="{{ url_for('product_detail', product_id=related_product.id) }}" 
                               class="btn btn-primary btn-sm mt-2">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Book {{ product.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('book_product', product_id=product.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pickup_date" class="form-label">Preferred Pickup Date</label>
                        <input type="date" class="form-control" id="pickup_date" name="pickup_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="booking_quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="booking_quantity" name="quantity" 
                               value="1" min="1" max="{{ product.stock_quantity }}" required>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Your product will be reserved for 7 days from the selected pickup date.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Booking</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Set minimum date for booking to today and set default date
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const pickupDateInput = document.getElementById('pickup_date');
    
    if (pickupDateInput) {
        // Set minimum date to today
        pickupDateInput.min = today;
        
        // Set default value to 3 days from today
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 3);
        const defaultDateString = defaultDate.toISOString().split('T')[0];
        pickupDateInput.value = defaultDateString;
    }
    
    // Add validation for booking quantity
    const bookingQuantity = document.getElementById('booking_quantity');
    const stockQuantity = {{ product.stock_quantity }};
    
    if (bookingQuantity) {
        bookingQuantity.addEventListener('change', function() {
            if (this.value > stockQuantity) {
                this.value = stockQuantity;
                alert('Cannot book more than available stock: ' + stockQuantity);
            }
        });
    }
});
</script>
{% endblock %}