{% extends "base.html" %}

{% block title %}Products - SunStyle{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Filters</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('products') }}">
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select name="category_id" class="form-select" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" 
                                    {{ 'selected' if request.args.get('category_id')|int == category.id }}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <select name="brand" class="form-select" onchange="this.form.submit()">
                                <option value="">All Brands</option>
                                {% for brand in brands %}
                                <option value="{{ brand }}" 
                                    {{ 'selected' if request.args.get('brand') == brand }}>
                                    {{ brand }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Style</label>
                            <select name="style" class="form-select" onchange="this.form.submit()">
                                <option value="">All Styles</option>
                                {% for style in styles %}
                                <option value="{{ style }}" 
                                    {{ 'selected' if request.args.get('style') == style }}>
                                    {{ style }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Price Range</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" name="min_price" class="form-control" placeholder="Min" 
                                           value="{{ request.args.get('min_price', '') }}">
                                </div>
                                <div class="col">
                                    <input type="number" name="max_price" class="form-control" placeholder="Max" 
                                           value="{{ request.args.get('max_price', '') }}">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                        <a href="{{ url_for('products') }}" class="btn btn-outline-secondary w-100 mt-2">Clear Filters</a>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>All Products</h2>
                <div class="input-group" style="width: 300px;">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search products...">
                    <button class="btn btn-outline-primary" type="button" onclick="searchProducts()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            {% if request.args.get('category_id') or request.args.get('brand') or request.args.get('style') or request.args.get('min_price') or request.args.get('max_price') %}
            <div class="alert alert-info mb-4">
                <strong>Active Filters:</strong>
                {% if request.args.get('category_id') %}
                <span class="badge bg-primary me-1">Category: {{ categories|selectattr('id', 'equalto', request.args.get('category_id')|int)|map(attribute='name')|first }}</span>
                {% endif %}
                {% if request.args.get('brand') %}
                <span class="badge bg-primary me-1">Brand: {{ request.args.get('brand') }}</span>
                {% endif %}
                {% if request.args.get('style') %}
                <span class="badge bg-primary me-1">Style: {{ request.args.get('style') }}</span>
                {% endif %}
                {% if request.args.get('min_price') %}
                <span class="badge bg-primary me-1">Min: ₹{{ request.args.get('min_price') }}</span>
                {% endif %}
                {% if request.args.get('max_price') %}
                <span class="badge bg-primary me-1">Max: ₹{{ request.args.get('max_price') }}</span>
                {% endif %}
            </div>
            {% endif %}

            <div class="row g-4" id="productsGrid">
                {% for product in products %}
                <div class="col-md-4 product-item">
                    <div class="product-card card h-100">
                        {% if product.image_url %}
                            <img src="{{ url_for('static', filename='uploads/products/' + product.image_url) }}" 
                                 class="card-img-top product-image" alt="{{ product.name }}" style="height: 250px; object-fit: cover;">
                        {% else %}
                            <img src="https://via.placeholder.com/300x250/007bff/ffffff?text={{ product.name|replace(' ', '+') }}" 
                                 class="card-img-top product-image" alt="{{ product.name }}" style="height: 250px; object-fit: cover;">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title product-name">{{ product.name }}</h5>
                            <p class="card-text text-muted">{{ product.brand }} • {{ product.style }}</p>
                            <p class="card-text small flex-grow-1">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
                            <div class="price mb-2">
                                <strong class="text-primary">₹{{ "%.2f"|format(product.price) }}</strong>
                                {% if product.discount_price %}
                                <small class="text-muted text-decoration-line-through ms-1">₹{{ "%.2f"|format(product.discount_price) }}</small>
                                {% endif %}
                            </div>
                            <div class="stock-info mb-2">
                                <span class="badge {{ 'bg-success' if product.stock_quantity > 10 else 'bg-warning' if product.stock_quantity > 0 else 'bg-danger' }}">
                                    {{ product.stock_quantity }} in stock
                                </span>
                            </div>
                            <div class="product-actions mt-auto">
                                <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                                   class="btn btn-primary btn-sm w-100 mb-2">View Details</a>
                                {% if current_user.is_authenticated and product.stock_quantity > 0 %}
                                <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="POST" class="w-100">
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="fas fa-shopping-cart"></i> Add to Cart
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <h4>No products found</h4>
                        <p>No products match your current filters. Try adjusting your search criteria.</p>
                        <a href="{{ url_for('products') }}" class="btn btn-primary">Clear Filters</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const productItems = document.querySelectorAll('.product-item');
    
    productItems.forEach(item => {
        const productName = item.querySelector('.product-name').textContent.toLowerCase();
        const productDescription = item.querySelector('.card-text').textContent.toLowerCase();
        
        if (productName.includes(searchTerm) || productDescription.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Enable search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchProducts();
    }
});
</script>

<style>
.product-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.product-image {
    transition: transform 0.2s ease-in-out;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}
</style>
{% endblock %}